local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Debris = game:GetService("Debris")

local Characters = ReplicatedStorage.Characters
local Vader = Characters.DarthVader
local Remotes = Vader.Remotes
local HitboxPunch = Characters.Combat.Peacemaker.HitboxPunch
local CombatHitbox = Characters.Combat.Fx.CombatHitbox

-- character related
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local VaderLS = Character:WaitForChild("DarthVader")
local Humanoid = Character:WaitForChild("Humanoid")
local HRP = Character:WaitForChild("HumanoidRootPart")
local Animator = Humanoid:WaitForChild("Animator")
local Animations = VaderLS.Animations

-- minor functions
local function Dash(hrp)
    local bp = Instance.new("BodyPosition")
    bp.MaxForce = Vector3.new(1000000, 0, 1000000)
    bp.P = 100000
    bp.D = 3000
    bp.Position = (hrp.CFrame * CFrame.new(0, 0, -15)).Position
    bp.Parent = hrp
    Debris:AddItem(bp, .2)
end

local function Leap(hrp, height, length)
    local bp = Instance.new("BodyPosition")
    bp.MaxForce = Vector3.new(1000000, 1000000, 1000000)
    bp.P = 80000
    bp.D = 3000
    bp.Position = (hrp.CFrame * CFrame.new(0, height, -length)).Position
    bp.Parent = hrp
    Debris:AddItem(bp, .7)
end

-- loading animations
local SaberThrowAnim = Animator:LoadAnimation(Animations.Throw)
local HeavyStrikeAnim = Animator:LoadAnimation(Animations.DownStrike)
local LeapAnim = Animator:LoadAnimation(Animations.Leap)
local ForceAnim = Animator:LoadAnimation(Animations.Pull)
local OmniSliceAnim = Animator:LoadAnimation(Characters.Jeffrey.AnimationsExtra.MoveFourAwakend)
local TriSliceAnim = Animator:LoadAnimation(Characters.Jeffrey.AnimationsExtra.MoveOne)

-- remotes
local Bash2 = Remotes.Bash2
local Finisher = Remotes.Finisher
local ForcePull = Remotes.Pull
local ForceChoke = Remotes.QuickChoke
local SaberThrowHit = Remotes.SaberThrowHit
local WindExplosion = Remotes.WindExplosion
local WindExplosion1 = Remotes.WindExplosion1

-- Connecting to animations (Saber Throw Logic)
SaberThrowAnim.KeyframeReached:Connect(function(kf)
    if kf == "Throw" then
        VaderLS.Throw:FireServer()
        local Hb = HitboxPunch:Clone()
        Hb.Parent = Character
        local Weld = Instance.new("Weld", Hb)
        Weld.Part1 = Character:FindFirstChild("SaberThrow")
        Weld.Part0 = Hb
        Weld.C0 = CFrame.new(0, 0, 0)
        Debris:AddItem(Hb, 0.8)
        
        local AntiSpam = {}
        Hb.Touched:Connect(function(part)
            local Parent = part.Parent
            local Hum = Parent:FindFirstChild("Humanoid")
            if Hum and Hum.Health ~= 0 and Hum ~= Humanoid then
                if not table.find(AntiSpam, Parent) then
                    for i=1,5 do SaberThrowHit:FireServer(Parent) end
                    table.insert(AntiSpam, Parent)
                    task.spawn(function()
                        task.wait(.3)
                        local pos = table.find(AntiSpam, Parent)
                        if pos then table.remove(AntiSpam, pos) end
                    end)
                end
            end
        end)
    elseif kf == "Back" then
        VaderLS.Back:FireServer()
    end
end)

--- Moves ---

local function MoveOne() -- Heavy Strike
    HeavyStrikeAnim:Play()
    VaderLS.HeavyStrike:FireServer()
    Dash(HRP)
    
    local Hb = CombatHitbox:Clone()
    Hb.Parent = Character
    local Weld = Instance.new("Weld", Hb)
    Weld.Part1 = Character:FindFirstChild("Saber")
    Weld.Part0 = Hb
    Debris:AddItem(Hb, 0.4)
    
    local AntiSpam = {}
    Hb.Touched:Connect(function(part)
        local Parent = part.Parent
        local Hum = Parent:FindFirstChild("Humanoid")
        if Hum and Hum.Health ~= 0 and Hum ~= Humanoid then
            if not table.find(AntiSpam, Parent) then
                for i=1,15 do Bash2:FireServer(Parent) end
                table.insert(AntiSpam, Parent)
                task.spawn(function()
                    task.wait(.3)
                    local pos = table.find(AntiSpam, Parent)
                    if pos then table.remove(AntiSpam, pos) end
                end)
            end
        end
    end)
end

--- Input Listener ---

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    -- Numeric Keybinds
    if input.KeyCode == Enum.KeyCode.One then
        MoveOne()
    elseif input.KeyCode == Enum.KeyCode.Two then
        SaberThrowAnim:Play()
    elseif input.KeyCode == Enum.KeyCode.Three then
        LeapAnim:Play()
        Leap(HRP, 65, 50)
    elseif input.KeyCode == Enum.KeyCode.Four then
        ForceAnim:Play()
        ForcePull:FireServer()
    elseif input.KeyCode == Enum.KeyCode.Five then
        Finisher:FireServer()
        
    -- Alphabetical Keybinds
    elseif input.KeyCode == Enum.KeyCode.E then -- Rage
        for i=1,150 do VaderLS.Rage:FireServer() end
        for i=1,5 do WindExplosion:FireServer() end
        
    elseif input.KeyCode == Enum.KeyCode.Z then -- Massive Wind
        for i=1,20 do WindExplosion:FireServer() end
        
    elseif input.KeyCode == Enum.KeyCode.X then -- Choke
        ForceAnim:Play()
        ForceChoke:FireServer()
        
    elseif input.KeyCode == Enum.KeyCode.C then -- High Leap
        LeapAnim:Play()
        Leap(HRP, 100, 100)

    	 elseif input.KeyCode == Enum.KeyCode.T then  
  for i=1,150 do VaderLS.Rage:FireServer() end
	 elseif input.KeyCode == Enum.KeyCode.V then   
OmniSliceAnim:Play()
    for i = 1, 12 do
	  local Hb = CombatHitbox:Clone()
        Hb.Parent = Character
        local Weld = Instance.new("Weld", Hb)
        Weld.Part1 = Character:FindFirstChild("Saber")
        Weld.Part0 = Hb
        Weld.C0 = CFrame.new(0, 0, 0)
        Debris:AddItem(Hb, 0.15)
        Hb.Touched:Connect(function(part)
            local Parent = part.Parent
            local Hum = Parent:FindFirstChild("Humanoid")
            if Hum and Hum.Health ~= 0 and Hum ~= Humanoid then
			Hb:Destroy()
                    for i=1,1 do Characters.Combat.Remotes.Combo:FireServer(Parent) end
					for i=1,1 do Bash2:FireServer(Parent) end
            end
        end)
        VaderLS.HeavyStrike:FireServer()
        task.wait(0.15)
    end
	 elseif input.KeyCode == Enum.KeyCode.B then 
TriSliceAnim:Play()
    for i = 1, 3 do
	  local Hb = CombatHitbox:Clone()
        Hb.Parent = Character
        local Weld = Instance.new("Weld", Hb)
        Weld.Part1 = Character:FindFirstChild("Saber")
        Weld.Part0 = Hb
        Weld.C0 = CFrame.new(0, 0, 0)
        Debris:AddItem(Hb, 0.15)
        Hb.Touched:Connect(function(part)
            local Parent = part.Parent
            local Hum = Parent:FindFirstChild("Humanoid")
            if Hum and Hum.Health ~= 0 and Hum ~= Humanoid then
			Hb:Destroy()
			   if i == 3 then for i=1,5 do Characters.Combat.Remotes.ComboEndRemote:FireServer(Parent) end   end
                    for i=1,3 do Characters.Combat.Remotes.Combo:FireServer(Parent) end
					for i=1,3 do Bash2:FireServer(Parent) end
            end
        end)
        VaderLS.HeavyStrike:FireServer()
        task.wait(0.3)
    end
    elseif input.KeyCode == Enum.KeyCode.Q then
        HeavyStrikeAnim:Play()
VaderLS.HeavyStrike:FireServer()
  local Hb = CombatHitbox:Clone()
        Hb.Parent = Character
        local Weld = Instance.new("Weld", Hb)
        Weld.Part1 = Character:FindFirstChild("Saber")
        Weld.Part0 = Hb
        Weld.C0 = CFrame.new(0, 0, 0)
        Debris:AddItem(Hb, 0.3)
        Hb.Touched:Connect(function(part)
            local Parent = part.Parent
            local Hum = Parent:FindFirstChild("Humanoid")
            if Hum and Hum.Health ~= 0 and Hum ~= Humanoid then
			Hb:Destroy()
                    for i=1,55 do Characters.Combat.Remotes.Combo:FireServer(Parent) end
					for i=1,55 do Bash2:FireServer(Parent) end
            end
        end)
    end
end)
